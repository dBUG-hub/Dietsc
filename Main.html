<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مخطط الوجبات الغذائية</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://cdn.jsdelivr.net/npm/lucide-react@0.378.0/dist/lucide-react.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #111827;
            color: #f9fafb;
        }
        .chart-container {
            position: relative;
            height: 250px;
            width: 250px;
        }
        .chart-center-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
        }
        .suggestion-item {
            transition: background-color 0.2s ease-in-out;
        }
        .suggestion-item:hover {
            background-color: #374151;
        }
        /* Custom scrollbar for better dark mode aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400 mb-2">ميزانك الغذائي</h1>
            <p class="text-gray-400">خطط وجباتك اليومية بدقة وسهولة</p>
        </header>

        <!-- Daily Summary -->
        <section id="daily-summary" class="bg-gray-800/50 backdrop-blur-sm rounded-2xl p-6 mb-8 shadow-lg border border-gray-700 animate-fade-in">
            <h2 class="text-2xl font-bold mb-6 text-emerald-400 border-b-2 border-emerald-400/30 pb-2">الملخص اليومي الكامل</h2>
            <div class="flex flex-col md:flex-row items-center justify-between gap-8">
                <!-- Macros Text -->
                <div class="w-full md:w-2/3 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 text-center">
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <h3 class="text-sm text-gray-400">السعرات</h3>
                        <p id="total-calories" class="text-2xl font-bold text-emerald-400">0</p>
                    </div>
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <h3 class="text-sm text-gray-400">البروتين</h3>
                        <p id="total-protein" class="text-2xl font-bold text-cyan-400">0 ج</p>
                    </div>
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <h3 class="text-sm text-gray-400">الكربوهيدرات</h3>
                        <p id="total-carbs" class="text-2xl font-bold text-amber-400">0 ج</p>
                    </div>
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <h3 class="text-sm text-gray-400">الدهون</h3>
                        <p id="total-fat" class="text-2xl font-bold text-rose-400">0 ج</p>
                    </div>
                    <div class="bg-gray-700/50 p-4 rounded-lg">
                        <h3 class="text-sm text-gray-400">الألياف</h3>
                        <p id="total-fiber" class="text-2xl font-bold text-lime-400">0 ج</p>
                    </div>
                </div>
                <!-- Macros Chart -->
                <div class="w-full md:w-1/3 flex justify-center items-center">
                    <div class="chart-container">
                        <canvas id="macros-chart"></canvas>
                        <div id="chart-center-text" class="chart-center-text">
                            <span class="text-2xl font-bold text-white">0<span class="text-sm">%</span></span>
                            <p class="text-xs text-gray-400">بروتين</p>
                        </div>
                    </div>
                </div>
            </div>
             <div class="mt-6 text-xs text-center text-gray-500">
                <p>تنويه: القيم الغذائية هي تقديرات وقد تختلف بناءً على طريقة الطهي والعلامة التجارية. للحصول على أقصى دقة، استخدم ميزة "إضافة منتج مخصص" بناءً على الملصق الغذائي للمنتج.</p>
            </div>
        </section>

        <!-- Meals Section -->
        <main id="meals-container" class="space-y-6">
            <!-- Meals will be dynamically added here -->
        </main>

        <!-- Action Buttons -->
        <div class="mt-8 flex flex-wrap gap-4 justify-center">
            <button onclick="addMeal()" class="flex items-center gap-2 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-lg">
                <i data-lucide="plus-circle"></i>
                <span>إضافة وجبة جديدة</span>
            </button>
            <button onclick="openCustomFoodModal()" class="flex items-center gap-2 bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-lg">
                 <i data-lucide="package-plus"></i>
                <span>إضافة منتج مخصص</span>
            </button>
            <button onclick="exportToPDF()" class="flex items-center gap-2 bg-rose-500 hover:bg-rose-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-lg">
                <i data-lucide="file-down"></i>
                <span>تصدير كـ PDF</span>
            </button>
             <button onclick="exportToCSV()" class="flex items-center gap-2 bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-lg">
                <i data-lucide="file-spreadsheet"></i>
                <span>تصدير كـ Excel</span>
            </button>
        </div>
    </div>

    <!-- Custom Food Modal -->
    <div id="custom-food-modal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex justify-center items-center hidden z-50">
        <div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md m-4 shadow-2xl border border-gray-700 animate-fade-in">
            <h2 class="text-2xl font-bold mb-6 text-cyan-400">إضافة منتج مخصص</h2>
            <form id="custom-food-form" class="space-y-4">
                <input type="text" id="custom-name" placeholder="اسم المنتج" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                <p class="text-xs text-gray-400 text-center">أدخل القيم الغذائية لكل 100 جرام</p>
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="custom-calories" placeholder="السعرات" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                    <input type="number" step="0.1" id="custom-protein" placeholder="البروتين (ج)" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                    <input type="number" step="0.1" id="custom-carbs" placeholder="الكربوهيدرات (ج)" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                    <input type="number" step="0.1" id="custom-fat" placeholder="الدهون (ج)" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                    <input type="number" step="0.1" id="custom-fiber" placeholder="الألياف (ج)" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                </div>
                <div class="flex gap-4 pt-4">
                    <button type="submit" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 rounded-lg transition-transform transform hover:scale-105">إضافة المنتج</button>
                    <button type="button" onclick="closeCustomFoodModal()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-lg transition-transform transform hover:scale-105">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- DATABASE ---
        // A detailed and accurate food database (per 100g).
        let foodDatabase = [
            { id: 1, name: 'صدر دجاج مشوي', calories: 165, protein: 31, carbs: 0, fat: 3.6, fiber: 0 },
            { id: 2, name: 'صدر دجاج مسلوق', calories: 151, protein: 30, carbs: 0, fat: 3, fiber: 0 },
            { id: 3, name: 'أرز أبيض مطبوخ', calories: 130, protein: 2.7, carbs: 28, fat: 0.3, fiber: 0.4 },
            { id: 4, name: 'أرز بني مطبوخ', calories: 111, protein: 2.6, carbs: 23, fat: 0.9, fiber: 1.8 },
            { id: 5, name: 'بطاطس مسلوقة', calories: 87, protein: 1.9, carbs: 20.1, fat: 0.1, fiber: 2.2 },
            { id: 6, name: 'بطاطا حلوة مخبوزة', calories: 90, protein: 2, carbs: 21, fat: 0.2, fiber: 3.3 },
            { id: 7, name: 'سلمون مشوي', calories: 206, protein: 22, carbs: 0, fat: 13, fiber: 0 },
            { id: 8, name: 'تونة معلبة بالماء', calories: 116, protein: 26, carbs: 0, fat: 1, fiber: 0 },
            { id: 9, name: 'بيض مسلوق (حبة كبيرة)', calories: 78, protein: 6.3, carbs: 0.6, fat: 5.3, fiber: 0 },
            { id: 10, name: 'لحم بقري مفروم (90% هبر)', calories: 199, protein: 28, carbs: 0, fat: 9, fiber: 0 },
            { id: 11, name: 'بروكلي مطبوخ', calories: 35, protein: 2.4, carbs: 7.2, fat: 0.4, fiber: 3.3 },
            { id: 12, name: 'سبانخ طازجة', calories: 23, protein: 2.9, carbs: 3.6, fat: 0.4, fiber: 2.2 },
            { id: 13, name: 'زيت زيتون', calories: 884, protein: 0, carbs: 0, fat: 100, fiber: 0 },
            { id: 14, name: 'أفوكادو', calories: 160, protein: 2, carbs: 9, fat: 15, fiber: 7 },
            { id: 15, name: 'لوز', calories: 579, protein: 21, carbs: 22, fat: 49, fiber: 12.5 },
            { id: 16, name: 'تفاح', calories: 52, protein: 0.3, carbs: 14, fat: 0.2, fiber: 2.4 },
            { id: 17, name: 'موز', calories: 89, protein: 1.1, carbs: 23, fat: 0.3, fiber: 2.6 },
            { id: 18, name: 'شوفان (غير مطبوخ)', calories: 389, protein: 16.9, carbs: 66.3, fat: 6.9, fiber: 10.6 },
            { id: 19, name: 'زبادي يوناني (قليل الدسم)', calories: 59, protein: 10, carbs: 3.6, fat: 0.4, fiber: 0 },
            { id: 20, name: 'خبز أسمر (شريحة)', calories: 75, protein: 3.5, carbs: 13, fat: 1.1, fiber: 1.9 },
        ];

        // --- STATE MANAGEMENT ---
        let dailyPlan = {
            meals: []
        };
        let nextMealId = 1;
        let nextItemId = 1;
        let macrosChart;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initializeChart();
            addMeal(); // Start with one meal by default
        });

        // --- CHART LOGIC ---
        function initializeChart() {
            const ctx = document.getElementById('macros-chart').getContext('2d');
            macrosChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['بروتين', 'كربوهيدرات', 'دهون'],
                    datasets: [{
                        data: [1, 1, 1], // Start with equal parts to avoid empty chart
                        backgroundColor: ['#22d3ee', '#facc15', '#fb7185'],
                        borderColor: '#1f2937',
                        borderWidth: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed.toFixed(1) + '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    onHover: (event, chartElement) => {
                        const chartCenterText = document.getElementById('chart-center-text');
                        if (chartElement.length > 0) {
                            const index = chartElement[0].index;
                            const data = macrosChart.data.datasets[0].data;
                            const label = macrosChart.data.labels[index];
                            const value = data[index];
                            chartCenterText.innerHTML = `<span class="text-2xl font-bold text-white">${value.toFixed(0)}<span class="text-sm">%</span></span><p class="text-xs text-gray-400">${label}</p>`;
                        }
                    }
                }
            });
        }

        // --- CORE LOGIC ---
        function addMeal() {
            const mealId = nextMealId++;
            dailyPlan.meals.push({
                id: mealId,
                name: `الوجبة ${mealId}`,
                items: []
            });
            renderMeals();
        }

        function addItemToMeal(mealId, foodId, grams) {
            const meal = dailyPlan.meals.find(m => m.id === mealId);
            const food = foodDatabase.find(f => f.id === foodId);
            if (meal && food && grams > 0) {
                meal.items.push({
                    id: nextItemId++,
                    foodId: food.id,
                    grams: parseFloat(grams)
                });
                renderMeals();
                updateTotals();
            }
        }

        function updateItemGrams(mealId, itemId, newGrams) {
            const meal = dailyPlan.meals.find(m => m.id === mealId);
            const item = meal.items.find(i => i.id === itemId);
            if (item) {
                if (newGrams > 0) {
                    item.grams = parseFloat(newGrams);
                } else {
                    // Remove item if grams are 0 or less
                    meal.items = meal.items.filter(i => i.id !== itemId);
                }
                renderMeals();
                updateTotals();
            }
        }
        
        function deleteItem(mealId, itemId) {
            const meal = dailyPlan.meals.find(m => m.id === mealId);
            if(meal) {
                meal.items = meal.items.filter(i => i.id !== itemId);
                renderMeals();
                updateTotals();
            }
        }

        function deleteMeal(mealId) {
            dailyPlan.meals = dailyPlan.meals.filter(m => m.id !== mealId);
            renderMeals();
            updateTotals();
        }

        function updateTotals() {
            let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0, totalFiber = 0;

            dailyPlan.meals.forEach(meal => {
                meal.items.forEach(item => {
                    const food = foodDatabase.find(f => f.id === item.foodId);
                    const multiplier = item.grams / 100;
                    totalCalories += food.calories * multiplier;
                    totalProtein += food.protein * multiplier;
                    totalCarbs += food.carbs * multiplier;
                    totalFat += food.fat * multiplier;
                    totalFiber += food.fiber * multiplier;
                });
            });

            document.getElementById('total-calories').textContent = totalCalories.toFixed(0);
            document.getElementById('total-protein').textContent = `${totalProtein.toFixed(1)} ج`;
            document.getElementById('total-carbs').textContent = `${totalCarbs.toFixed(1)} ج`;
            document.getElementById('total-fat').textContent = `${totalFat.toFixed(1)} ج`;
            document.getElementById('total-fiber').textContent = `${totalFiber.toFixed(1)} ج`;

            // Update chart
            const proteinCalories = totalProtein * 4;
            const carbsCalories = totalCarbs * 4;
            const fatCalories = totalFat * 9;
            const totalMacroCalories = proteinCalories + carbsCalories + fatCalories;

            let proteinPercentage = 0, carbsPercentage = 0, fatPercentage = 0;
            if (totalMacroCalories > 0) {
                proteinPercentage = (proteinCalories / totalMacroCalories) * 100;
                carbsPercentage = (carbsCalories / totalMacroCalories) * 100;
                fatPercentage = (fatCalories / totalMacroCalories) * 100;
            }
            
            macrosChart.data.datasets[0].data = [proteinPercentage, carbsPercentage, fatPercentage];
            macrosChart.update();
            
            const chartCenterText = document.getElementById('chart-center-text');
            chartCenterText.innerHTML = `<span class="text-2xl font-bold text-white">${proteinPercentage.toFixed(0)}<span class="text-sm">%</span></span><p class="text-xs text-gray-400">بروتين</p>`;
        }

        // --- RENDERING ---
        function renderMeals() {
            const container = document.getElementById('meals-container');
            container.innerHTML = '';
            dailyPlan.meals.forEach(meal => {
                const mealElement = document.createElement('div');
                mealElement.className = 'bg-gray-800/50 backdrop-blur-sm rounded-2xl p-6 shadow-lg border border-gray-700 animate-fade-in';
                mealElement.innerHTML = createMealHTML(meal);
                container.appendChild(mealElement);
                attachEventListenersToMeal(meal.id);
            });
            lucide.createIcons();
        }

        function createMealHTML(meal) {
            let mealTotalCalories = 0, mealTotalProtein = 0, mealTotalCarbs = 0, mealTotalFat = 0, mealTotalFiber = 0;
            const itemsHTML = meal.items.map(item => {
                const food = foodDatabase.find(f => f.id === item.foodId);
                const multiplier = item.grams / 100;
                mealTotalCalories += food.calories * multiplier;
                mealTotalProtein += food.protein * multiplier;
                mealTotalCarbs += food.carbs * multiplier;
                mealTotalFat += food.fat * multiplier;
                mealTotalFiber += food.fiber * multiplier;
                
                return `
                    <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                        <td class="p-3">${food.name}</td>
                        <td class="p-3">
                            <input type="number" value="${item.grams}" onchange="updateItemGrams(${meal.id}, ${item.id}, this.value)" class="w-20 bg-gray-600 text-center rounded-md p-1 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        </td>
                        <td class="p-3">${(food.calories * multiplier).toFixed(0)}</td>
                        <td class="p-3">${(food.protein * multiplier).toFixed(1)}</td>
                        <td class="p-3">${(food.carbs * multiplier).toFixed(1)}</td>
                        <td class="p-3">${(food.fat * multiplier).toFixed(1)}</td>
                        <td class="p-3">${(food.fiber * multiplier).toFixed(1)}</td>
                        <td class="p-3 text-center">
                            <button onclick="deleteItem(${meal.id}, ${item.id})" class="text-rose-400 hover:text-rose-600"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-emerald-400">${meal.name}</h2>
                     <button onclick="deleteMeal(${meal.id})" class="text-gray-400 hover:text-white"><i data-lucide="x-circle" class="w-6 h-6"></i></button>
                </div>
                <!-- Meal Summary -->
                <div class="grid grid-cols-2 sm:grid-cols-5 gap-2 mb-4 text-center text-sm">
                    <div class="bg-gray-700/30 p-2 rounded-md"><span class="font-bold">${mealTotalCalories.toFixed(0)}</span> سعرة</div>
                    <div class="bg-gray-700/30 p-2 rounded-md"><span class="font-bold">${mealTotalProtein.toFixed(1)}</span> بروتين</div>
                    <div class="bg-gray-700/30 p-2 rounded-md"><span class="font-bold">${mealTotalCarbs.toFixed(1)}</span> كارب</div>
                    <div class="bg-gray-700/30 p-2 rounded-md"><span class="font-bold">${mealTotalFat.toFixed(1)}</span> دهون</div>
                    <div class="bg-gray-700/30 p-2 rounded-md"><span class="font-bold">${mealTotalFiber.toFixed(1)}</span> ألياف</div>
                </div>
                <!-- Meal Items Table -->
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-400 uppercase bg-gray-700/50">
                            <tr>
                                <th class="p-3">الصنف</th>
                                <th class="p-3">الكمية (ج)</th>
                                <th class="p-3">سعرات</th>
                                <th class="p-3">بروتين</th>
                                <th class="p-3">كارب</th>
                                <th class="p-3">دهون</th>
                                <th class="p-3">ألياف</th>
                                <th class="p-3"></th>
                            </tr>
                        </thead>
                        <tbody>${itemsHTML}</tbody>
                    </table>
                </div>
                <!-- Add Item Form -->
                <div class="mt-4 relative">
                    <form id="form-meal-${meal.id}" class="flex flex-col sm:flex-row gap-2">
                        <div class="relative flex-grow">
                            <input type="text" id="food-input-${meal.id}" placeholder="ابحث عن صنف..." class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <div id="suggestions-${meal.id}" class="absolute z-10 w-full bg-gray-800 border border-gray-600 rounded-lg mt-1 max-h-60 overflow-y-auto hidden shadow-lg"></div>
                        </div>
                        <input type="number" id="grams-input-${meal.id}" placeholder="الكمية (جرام)" class="w-full sm:w-32 bg-gray-700 border border-gray-600 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <button type="submit" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold p-3 rounded-lg flex justify-center items-center transition-transform transform hover:scale-105"><i data-lucide="plus"></i></button>
                    </form>
                </div>
            `;
        }

        // --- EVENT LISTENERS ---
        function attachEventListenersToMeal(mealId) {
            const form = document.getElementById(`form-meal-${mealId}`);
            const foodInput = document.getElementById(`food-input-${mealId}`);
            const gramsInput = document.getElementById(`grams-input-${mealId}`);
            const suggestionsBox = document.getElementById(`suggestions-${mealId}`);
            let selectedFoodId = null;

            foodInput.addEventListener('keyup', (e) => {
                const query = e.target.value.toLowerCase();
                if (query.length > 1) {
                    const filteredFoods = foodDatabase.filter(food => food.name.toLowerCase().includes(query));
                    suggestionsBox.innerHTML = filteredFoods.map(food => 
                        `<div class="p-3 cursor-pointer suggestion-item" data-id="${food.id}" data-name="${food.name}">${food.name}</div>`
                    ).join('');
                    suggestionsBox.classList.remove('hidden');
                } else {
                    suggestionsBox.classList.add('hidden');
                }
            });

            suggestionsBox.addEventListener('click', (e) => {
                if (e.target.matches('.suggestion-item')) {
                    selectedFoodId = parseInt(e.target.dataset.id);
                    foodInput.value = e.target.dataset.name;
                    suggestionsBox.classList.add('hidden');
                    gramsInput.focus();
                }
            });

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const grams = gramsInput.value;
                if (selectedFoodId && grams) {
                    addItemToMeal(mealId, selectedFoodId, grams);
                    form.reset();
                    selectedFoodId = null;
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!form.contains(e.target)) {
                    suggestionsBox.classList.add('hidden');
                }
            });
        }
        
        // --- CUSTOM FOOD MODAL ---
        function openCustomFoodModal() {
            document.getElementById('custom-food-modal').classList.remove('hidden');
        }

        function closeCustomFoodModal() {
            document.getElementById('custom-food-modal').classList.add('hidden');
            document.getElementById('custom-food-form').reset();
        }

        document.getElementById('custom-food-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const newFood = {
                id: foodDatabase.length + 1000, // Use a high number to avoid conflicts
                name: document.getElementById('custom-name').value,
                calories: parseFloat(document.getElementById('custom-calories').value),
                protein: parseFloat(document.getElementById('custom-protein').value),
                carbs: parseFloat(document.getElementById('custom-carbs').value),
                fat: parseFloat(document.getElementById('custom-fat').value),
                fiber: parseFloat(document.getElementById('custom-fiber').value) || 0,
            };
            foodDatabase.push(newFood);
            closeCustomFoodModal();
        });

        // --- EXPORT FUNCTIONS ---
        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add Arabic font support
            // This is a simplified approach. For full support, you might need a custom font file.
            doc.setFont('helvetica', 'normal'); // Fallback font
            doc.setRtl(true);

            let finalY = 20;
            doc.text("تقرير الوجبات اليومي", 105, finalY, { align: 'center' });
            finalY += 10;

            const summaryHeaders = [["الألياف", "الدهون", "الكربوهيدرات", "البروتين", "السعرات الحرارية"]];
            const summaryData = [[
                document.getElementById('total-fiber').textContent,
                document.getElementById('total-fat').textContent,
                document.getElementById('total-carbs').textContent,
                document.getElementById('total-protein').textContent,
                document.getElementById('total-calories').textContent
            ]];

            doc.autoTable({
                startY: finalY,
                head: summaryHeaders,
                body: summaryData,
                theme: 'grid',
                headStyles: { halign: 'center', fillColor: [34, 197, 94] },
                bodyStyles: { halign: 'center' },
            });
            finalY = doc.autoTable.previous.finalY + 15;

            dailyPlan.meals.forEach(meal => {
                doc.text(meal.name, 200, finalY, { align: 'right' });
                finalY += 5;
                const mealHeaders = [["", "ألياف", "دهون", "كارب", "بروتين", "سعرات", "كمية (ج)", "الصنف"]];
                const mealData = meal.items.map(item => {
                    const food = foodDatabase.find(f => f.id === item.foodId);
                    const multiplier = item.grams / 100;
                    return [
                        "",
                        (food.fiber * multiplier).toFixed(1),
                        (food.fat * multiplier).toFixed(1),
                        (food.carbs * multiplier).toFixed(1),
                        (food.protein * multiplier).toFixed(1),
                        (food.calories * multiplier).toFixed(0),
                        item.grams,
                        food.name
                    ];
                });

                doc.autoTable({
                    startY: finalY,
                    head: mealHeaders,
                    body: mealData,
                    theme: 'striped',
                    headStyles: { halign: 'center' },
                    bodyStyles: { halign: 'center' },
                });
                finalY = doc.autoTable.previous.finalY + 15;
            });

            doc.save('MyDailyPlan.pdf');
        }
        
        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // \uFEFF for BOM to support Arabic in Excel
            csvContent += "الوجبة,الصنف,الكمية (جرام),السعرات,البروتين (ج),الكربوهيدرات (ج),الدهون (ج),الألياف (ج)\r\n";

            dailyPlan.meals.forEach(meal => {
                meal.items.forEach(item => {
                    const food = foodDatabase.find(f => f.id === item.foodId);
                    const multiplier = item.grams / 100;
                    const row = [
                        meal.name,
                        food.name,
                        item.grams,
                        (food.calories * multiplier).toFixed(0),
                        (food.protein * multiplier).toFixed(1),
                        (food.carbs * multiplier).toFixed(1),
                        (food.fat * multiplier).toFixed(1),
                        (food.fiber * multiplier).toFixed(1)
                    ].join(',');
                    csvContent += row + "\r\n";
                });
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "MyDailyPlan.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
  </html>
